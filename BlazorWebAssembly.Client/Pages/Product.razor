@page "/products"
@using System.Net.Http.Json
@using MudBlazor
@inject HttpClient Http


<PageTitle>Products</PageTitle>
<MudContainer>
    <MudText Typo="Typo.h4">Products</MudText>

    <MudTable Items="@products" Hover="true">
        <HeaderContent>
            <MudTh>Barcode</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Price</MudTh>
            <MudTh>Image</MudTh>
            <MudTh>Stock</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.ProductBarcode</MudTd>
            <MudTd>@context.ProductName</MudTd>
            <MudTd>@context.Price</MudTd>
            <MudTd>@context.ImagePath</MudTd>
            <MudTd>@context.Stock</MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private List<ProductModel> products = new List<ProductModel>();

    // This method will run on page initialization
    protected override async Task OnInitializedAsync()
    {

        // Fetching the product data from the backend API
        var response = await Http.GetFromJsonAsync<ApiResponse>("products");

        if (response?.Data != null)
        {
            Console.WriteLine($"Fetched {response.Data.Count} products");
            foreach (var p in response.Data)
            {
                Console.WriteLine($"Product: {p.ProductName}, Barcode: {p.ProductBarcode}");
            }
            // Mapping API response to local product model
            products = response.Data.Select(p => new ProductModel
            {
                ProductBarcode = p.ProductBarcode ?? string.Empty, // Use default value if null
                ProductName = p.ProductName ?? string.Empty, // Use default value if null
                ImagePath = p.ImagePath ?? string.Empty, // Use default value if null
                Price = p.Price,
                Stock = p.Stock?.Quantity ?? 0 // Ensure Stock is initialized
            }).ToList();
        }
    }

    // Product model to map API data
    public class ProductModel
    {
        public string ProductBarcode { get; set; }
        public string ProductName { get; set; }
        public string ImagePath { get; set; }
        public uint Price { get; set; }
        public int Stock { get; set; }
    }

    // API Response model
    public class ApiResponse
    {
        public string? Status { get; set; }
        public List<ApiProduct>? Data { get; set; }
    }

    // API Product model
    public class ApiProduct
    {
        public int ID { get; set; }
        public string? ProductBarcode { get; set; }
        public string? ProductName { get; set; }
        public string? ImagePath { get; set; }
        public uint Price { get; set; }
        public Stock? Stock { get; set; }
    }

    // Stock model
    public class Stock
    {
        public int Quantity { get; set; }
    }
}
