@page "/products"
@using System.Text.Json
@inject HttpClient Http
@using MudBlazor
@using System.Text.Json.Serialization;

<PageTitle>Products</PageTitle>
<MudContainer>
    <MudText Typo="Typo.h4">Products</MudText>

    <MudTable Items="@products" Hover="true">
        <HeaderContent>
            <MudTh>Barcode</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Price</MudTh>
            <MudTh>Image</MudTh>
            <MudTh>Stock</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.ProductBarcode</MudTd>
            <MudTd>@context.ProductName</MudTd>
            <MudTd>@context.Price</MudTd>
            <MudTd>@context.ImagePath</MudTd>
            <MudTd>@context.Stock</MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private List<ProductModel> products = new List<ProductModel>();
    private bool getProductsError;
    private bool shouldRender;

    protected override bool ShouldRender() => shouldRender;

    // This method will run on page initialization
    protected override async Task OnInitializedAsync()
    {
        var response = await Http.GetFromJsonAsync<ApiResponse>("http://localhost:8080/api/products");

        if (response?.Data != null)
        {
            products = response.Data.Select(p => new ProductModel
            {
                ProductBarcode = p.ProductBarcode ?? string.Empty,
                ProductName = p.ProductName ?? string.Empty,
                ImagePath = p.ImagePath ?? string.Empty,
                Price = p.Price,
                Stock = p.Stock?.Quantity ?? 0
            }).ToList();
        }


        shouldRender = true;
    }

    public class ProductModel
    {
        public string ProductBarcode { get; set; } = string.Empty;
        public string ProductName { get; set; } = string.Empty;
        public string ImagePath { get; set; } = string.Empty;
        public uint Price { get; set; }
        public int Stock { get; set; }
    }

    public class ApiResponse
    {
        public string? Status { get; set; }
        public List<ApiProduct>? Data { get; set; }
    }

    public class ApiProduct
    {
        public int ID { get; set; }
        [JsonPropertyName("product_barcode")]
        public string? ProductBarcode { get; set; }
        [JsonPropertyName("product_name")]
        public string? ProductName { get; set; }
        [JsonPropertyName("image_path")]
        public string? ImagePath { get; set; }
        [JsonPropertyName("price")]
        public uint Price { get; set; }
        [JsonPropertyName("stock")]
        public Stock? Stock { get; set; }
    }

    public class Stock
    {
        [JsonPropertyName("quantity")]
        public int Quantity { get; set; }
    }
}
